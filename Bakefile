#!/bin/bash -eu

SRC=src
DIST=dist
REMOTE=s11
DOMAIN=roblog.nl

FORMAT="prettier --ignore-path .prettierignore"
COPY="rsync -au --delete "$SRC/" "$DIST/" --exclude images"
DEPLOY="rsync -ciavuP --delete --exclude 'canvas.json'"

setup() {
  bun i
}

deploy() {
  if [ -d $DIST ]; then
    $DEPLOY $DIST/ $REMOTE:domains/$DOMAIN/public_html
  else
    echo >&2 "Error: '$DIST' does not exist."
    echo >&2
  fi
}

format() {
  $FORMAT --write $SRC
}

serve() {
  cd $SRC
  waiter --dev
}

clean() {
  rm -rf $DIST
  rm -rf node_modules bun.lockb
}

build() {
  p:process_files
  # p:build_assets
  p:generate_sitemap
  # p:generate_feeds
}

p:process_files() {
  local changed_files="$($COPY -i | grep -v '/$' | cut -d' ' -f2)"

  printf "Updating these files: "
  echo "$changed_files"

  echo

  while IFS= read -r file; do
    if [[ "$file" == *.html ]]; then
      cat "$SRC/$file" | lowc | shortc | smartypants | sed '/<\/head>/i\\n<link rel="stylesheet" href="/main.css" />' > "$DIST/$file"

      local lastmod="$(git log --pretty=format:%cI -1 HEAD -- "$SRC/$file")"
      $FORMAT --write "$DIST/$file" >/dev/null

      # The `+1 second` is because rsync will overwrite files
      # if they have the exact same last mod date, while I want it
      # to only overwrite if the source is newer.
      touch -d "$lastmod + 1 second" "$DIST/$file"
      printf .
    fi
  done <<< "$changed_files"

  # echo "done"
}

p:build_assets() {
  find "$SRC" -type f \( -iname "*.jpg" -o -iname "*.png" -o -iname "*.jpeg" \) -printf "%P\n" | xargs -I {} optim "$SRC/{}" "$DIST/{}"
}

p:generate_sitemap() {
  local sitemap="$DIST/sitemap.xml"
  local files=$(find "$DIST" -type f -name "*.html")

  export DOMAIN
  genmap $sitemap $files

  # My canonical URLs are without the .html suffix
  sed -i 's/\.html//g' $sitemap
}
