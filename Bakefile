#!/bin/bash

required bakery
required optim
required smartypants

SRC=src
DIST=dist
REMOTE=s11
DOMAIN=geheimesite.nl

FORMAT="prettier --ignore-path .prettierignore"
VALIDATE="vnu --exit-zero-always --Werror --filterfile .vnuignore"
DEPLOY="rsync -ciavuP --delete --exclude canvas.json"

export TITLE="Robin Boers"
export AUTHOR="Robin Boers"
export BIO="Thoughts and opinions of a teenager from the Netherlands."
export CANONICAL="$DOMAIN"
export FORMATTER="$FORMAT --write"
export NO_STYLESHEET=1
export NO_BLOG=1

deploy() {
  if [ -d $DIST ]; then
    $DEPLOY $DIST/ $REMOTE:domains/$DOMAIN/public_html
  else
    err "'$DIST' does not exist."
  fi
}

format() {
  git restore-mtime
  $FORMAT --write $SRC
}

clean() {
  rm -rf $DIST
}

build() {
  bakery build $SRC $DIST

  # My canonical URLs are without the .html suffix.
  sed -i '' 's/\.html//g' "$DIST/sitemap.xml"
}

serve() {
  cd $DIST
  waiter --dev
}

check() {
  printf "Running formatter... "
  $FORMAT --check $DIST --log-level warn && p:great

  printf "Running validators... "
  $VALIDATE --skip-non-html $DIST && p:great
  
  printf "Running stylelint... "
  stylelint "$SRC/**/*.css" && p:great

  printf "\nRunning achecker...\n"
  achecker $DIST && p:great

  # BLOCKED: htmltest doesn't yet support pretty URLs like I have,
  # see https://github.com/wjdp/htmltest/issues/183

  # echo
  # echo "Running htmltest"
  # htmltest
}

p:great() {
  GREEN="\033[1;32m"
  CLEAR="\033[0m"

  printf "${GREEN}no issues${CLEAR}\n"
}
